# üìä –°–µ—Ä–≤—ñ—Å —ñ–Ω–≥–µ—Å—Ç—É –ø–æ–¥—ñ–π —Ç–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏

## üß© –û–≥–ª—è–¥
–¶–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π —Å–µ—Ä–≤—ñ—Å –¥–ª—è –∑–±–æ—Ä—É –ø–æ–¥—ñ–π (event ingestion) —ñ –ø–æ–±—É–¥–æ–≤–∏ –ø—Ä–æ—Å—Ç–∏—Ö –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏—Ö –º–µ—Ç—Ä–∏–∫ (DAU, top events, retention).
–ü–æ–±—É–¥–æ–≤–∞–Ω–∏–π –Ω–∞ Litestar, –∑ —á–µ—Ä–≥–æ—é NATS JetStream, –≥–∞—Ä—è—á–∏–º —à–∞—Ä–æ–º —É ScyllaDB —ñ —Ö–æ–ª–æ–¥–Ω–∏–º —É ClickHouse.

---

## ‚öôÔ∏è –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞
POST /events
   ‚Üì
Backend (Litestar + msgspec)
   ‚Üì
NATS JetStream (—á–µ—Ä–≥–∞ –ø–æ–¥—ñ–π)
   ‚Üì
Worker (–∫–æ–Ω—Å—é–º–µ—Ä)
   ‚Üì
ScyllaDB ‚Üê –≥–∞—Ä—è—á–∏–π —à–∞—Ä (—à–≤–∏–¥–∫–∏–π –∑–∞–ø–∏—Å)
   ‚Üì
ClickHouse ‚Üê —Ö–æ–ª–æ–¥–Ω–∏–π —à–∞—Ä (–∞–Ω–∞–ª—ñ—Ç–∏–∫–∞)

Prometheus –∑–±–∏—Ä–∞—î –º–µ—Ç—Ä–∏–∫–∏ –∑ backend‚Äô–∞ (/metrics).

---

## üöÄ –ó–∞–ø—É—Å–∫
docker-compose -f docker-compose-dev up -d

### –°–µ—Ä–≤—ñ—Å–∏
- backend: REST API (—ñ–Ω–≥–µ—Å—Ç –ø–æ–¥—ñ–π, –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞)
- worker: –°–ø–æ–∂–∏–≤–∞—á —ñ–∑ NATS, –∑–∞–ø–∏—Å —É ScyllaDB —ñ ClickHouse
- nats: –ß–µ—Ä–≥–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å JetStream
- scylla: OLTP –±–∞–∑–∞ –¥–ª—è —à–≤–∏–¥–∫–∏—Ö –∑–∞–ø–∏—Å—ñ–≤
- clickhouse: OLAP –±–∞–∑–∞ –¥–ª—è –∞–Ω–∞–ª—ñ—Ç–∏–∫–∏
- prometheus: –ó–±—ñ—Ä –º–µ—Ç—Ä–∏–∫
- scylla-init / clickhouse-init: –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å—Ö–µ–º –±–∞–∑
- data-importer: –Ü–º–ø–æ—Ä—Ç —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö CSV-–¥–∞–Ω–∏—Ö

### –ü–æ—Ä—Ç–∏
- Backend API: http://127.0.0.1:8000
- Swagger UI: http://127.0.0.1:8000/schema/swagger
- Prometheus: http://127.0.0.1:9090
- Scylla: 9042
- ClickHouse: 8123

---

## üîå API

### POST /events
–ü—Ä–∏–π–º–∞—î –º–∞—Å–∏–≤ –ø–æ–¥—ñ–π –¥–ª—è –∑–∞–ø–∏—Å—É.
–Ü–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å –∑–∞–±–µ–∑–ø–µ—á—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ event_id.

–ü—Ä–∏–∫–ª–∞–¥:
  [
    {
      "event_id": "uuid",
      "occurred_at": "2025-10-28T12:00:00Z",
      "user_id": 1,
      "event_type": "view_item",
      "properties": {"country": "UA"}
    }
  ]

201 Created ‚Äî –ø–æ–¥—ñ—ó –ø—Ä–∏–π–Ω—è—Ç–æ —É —á–µ—Ä–≥—É

---

### GET /stats/dau?from=YYYY-MM-DD&to=YYYY-MM-DD
–ü–æ–≤–µ—Ä—Ç–∞—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ (DAU) –ø–æ –¥–Ω—è—Ö.
–ê–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π –∑–∞–ø–∏—Ç —É ClickHouse.

---

### GET /stats/top-events?from=YYYY-MM-DD&to=YYYY-MM-DD&limit=10
–ü–æ–≤–µ—Ä—Ç–∞—î —Ç–æ–ø —Ç–∏–ø—ñ–≤ –ø–æ–¥—ñ–π –∑–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—é.

---

### GET /stats/retention?start_date=YYYY-MM-DD&windows=3
–ü—Ä–æ—Å—Ç–∏–π –∫–æ–≥–æ—Ä—Ç–Ω–∏–π —Ä–µ—Ç–µ–Ω—à–Ω –∑–∞ –¥–Ω—è–º–∏.
–û–±—á–∏—Å–ª—é—î—Ç—å—Å—è –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ —É ClickHouse.

---

## üì¶ –Ü–º–ø–æ—Ä—Ç —ñ—Å—Ç–æ—Ä–∏—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö
CSV-—ñ–º–ø–æ—Ä—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è —É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ data-importer.
–ú–æ–∂–Ω–∞ –≤–∏–∫–æ–Ω–∞—Ç–∏ –≤—Ä—É—á–Ω—É:
  python import-events.py /data/events_sample.csv

–§–æ—Ä–º–∞—Ç CSV:
  - event_id: UUID
  - occurred_at: ISO-8601
  - user_id: UInt64
  - event_type: String
  - properties: JSON-–æ–±‚Äô—î–∫—Ç

---

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è
–ó–∞–ø—É—Å–∫ —é–Ω—ñ—Ç- —Ç–∞ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ–π–Ω–∏—Ö —Ç–µ—Å—Ç—ñ–≤:
  pytest -v

–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ–π–Ω–∏–π —à–ª—è—Ö:
  POST /events ‚Üí NATS ‚Üí Worker ‚Üí ClickHouse ‚Üí GET /stats/dau

Unit-—Ç–µ—Å—Ç –ø–µ—Ä–µ–≤—ñ—Ä—è—î —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å –ø–æ–¥—ñ–π (–æ–¥–∏–Ω event_id ‚Äî –æ–¥–Ω–∞ –≤—Å—Ç–∞–≤–∫–∞).

---

## üìà –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å

### –ú–µ—Ç–æ–¥–∏–∫–∞
–ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —á–µ—Ä–µ–∑ Vegeta:
  150 RPS, —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å 30s, —Å–µ—Ä–µ–¥–Ω—ñ–π —Ä–æ–∑–º—ñ—Ä –±–∞—Ç—á—É ‚Äî 1 –ø–æ–¥—ñ—è.

### –†–µ–∑—É–ª—å—Ç–∞—Ç–∏
- analytics_backend: 42.95% CPU, 114.7 MiB RAM ‚Äî –æ–±—Ä–æ–±–∫–∞ HTTP
- analytics_worker: 55.81% CPU, 39.8 MiB RAM ‚Äî –∑–∞–ø–∏—Å —É –ë–î
- analytics_nats: 20.7% CPU, 35.6 MiB RAM ‚Äî –∞–∫—Ç–∏–≤–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞
- analytics_clickhouse: 0.75% CPU, 337.1 MiB RAM ‚Äî –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω—ñ –≤—Å—Ç–∞–≤–∫–∏
- analytics_scylla: 7.42% CPU, 93.8 MiB RAM ‚Äî –≥–∞—Ä—è—á–∏–π —à–∞—Ä
- prometheus: 0.12% CPU, 21.4 MiB RAM ‚Äî –º–µ—Ç—Ä–∏–∫–∏

–°–µ—Ä–µ–¥–Ω—è –ª–∞—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å: 3.45 –º—Å
–ú—ñ–Ω—ñ–º—É–º: 2.1 –º—Å
–ú–∞–∫—Å–∏–º—É–º: 29.82 –º—Å

### –í—É–∑—å–∫—ñ –º—ñ—Å—Ü—è
- CPU backend —ñ worker –ø—Ä–∏ –ø—ñ–∫–æ–≤–∏—Ö RPS
- ClickHouse —ñ Scylla –∑–∞–ª–∏—à–∞–ª–∏—Å—å —Å—Ç–∞–±—ñ–ª—å–Ω–∏–º–∏

### –û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è
- –Ü–Ω—Å–µ—Ä—Ç –ø–æ–¥—ñ–π —É Scylla –±–∞—Ç—á–∞–º–∏
- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–µ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è backend/worker
- –ü–µ—Ä–µ–ø–∏—Å ingestion-—á–∞—Å—Ç–∏–Ω–∏ —Ç–∞ –∞–ø—ñ –Ω–∞ Go –∞–±–æ Rust

---

## üîç –°–ø–æ—Å—Ç–µ—Ä–µ–∂—É–≤–∞–Ω—ñ—Å—Ç—å
- –°—Ç—Ä—É–∫—Ç—É—Ä–æ–≤–∞–Ω—ñ –ª–æ–≥–∏: timestamp, level, route, status_code, latency_ms
- –ú–µ—Ç—Ä–∏–∫–∏ Prometheus:
  - REQUEST_COUNT{status="<code>"} ‚Äî –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Ç—ñ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å–∞—Ö
  - RPS ‚Äî –∑–∞–ø–∏—Ç–∏/—Å–µ–∫—É–Ω–¥–∞ (–æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è —É middleware)

---

## üõ°Ô∏è –ë–µ–∑–ø–µ–∫–∞ —Ç–∞ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—Å—Ç—å
- –í–∞–ª—ñ–¥–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö —á–µ—Ä–µ–∑ msgspec (—à–≤–∏–¥—à–µ –∑–∞ Pydantic)
- Rate-limit —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ middleware-–æ–º —É –ø–∞–º‚Äô—è—Ç—ñ (Litestar)
- –ê–∫—É—Ä–∞—Ç–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –∫–æ–¥—ñ–≤ –ø–æ–º–∏–ª–æ–∫ (400, 429)

---
